=============================
Lab 40 - Secure Flask Microservice (Case Study)
Execution Output Log
=============================

----------------------------------------
Lab Setup
----------------------------------------

$ mkdir flask-microservice-lab && cd flask-microservice-lab


$ pwd
/home/centos/flask-microservice-lab


$ podman --version
podman version 3.4.4


$ podman-compose --version
podman-compose version: 1.0.6


----------------------------------------
Task 1 - Create Flask Application
----------------------------------------

$ python3 -m venv venv


$ source venv/bin/activate
(venv)


$ pip install flask psycopg2-binary
Collecting flask
  Downloading Flask-3.0.3-py3-none-any.whl (101 kB)
Collecting psycopg2-binary
  Downloading psycopg2_binary-2.9.9-cp36-cp36m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (3.0 MB)
Collecting Werkzeug>=3.0.0
  Downloading werkzeug-3.0.3-py3-none-any.whl (227 kB)
Collecting Jinja2>=3.1.2
  Downloading Jinja2-3.1.4-py3-none-any.whl (133 kB)
Collecting itsdangerous>=2.1.2
  Downloading itsdangerous-2.2.0-py3-none-any.whl (16 kB)
Collecting click>=8.1.3
  Downloading click-8.1.7-py3-none-any.whl (97 kB)
Collecting blinker>=1.6.2
  Downloading blinker-1.8.2-py3-none-any.whl (9.5 kB)
Collecting MarkupSafe>=2.0
  Downloading MarkupSafe-2.1.5-cp36-cp36m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl (28 kB)
Installing collected packages: psycopg2-binary, MarkupSafe, blinker, click, itsdangerous, Jinja2, Werkzeug, flask
Successfully installed Jinja2-3.1.4 MarkupSafe-2.1.5 Werkzeug-3.0.3 blinker-1.8.2 click-8.1.7 flask-3.0.3 itsdangerous-2.2.0 psycopg2-binary-2.9.9


$ nano app.py


$ sed -n '1,200p' app.py
from flask import Flask, jsonify
import psycopg2
import os

app = Flask(__name__)

# Database configuration from environment
DB_HOST = os.getenv('DB_HOST', 'localhost')
DB_NAME = os.getenv('DB_NAME', 'mydb')
DB_USER = os.getenv('DB_USER', 'postgres')
DB_PASS = os.getenv('DB_PASS', 'password')

def get_db_connection():
    return psycopg2.connect(
        host=DB_HOST,
        database=DB_NAME,
        user=DB_USER,
        password=DB_PASS
    )

@app.route('/')
def hello():
    return jsonify({"status": "OK", "message": "Flask Microservice Running"})

@app.route('/data')
def get_data():
    conn = get_db_connection()
    cur = conn.cursor()
    cur.execute('SELECT version();')
    db_version = cur.fetchone()
    cur.close()
    conn.close()
    return jsonify({"database": db_version[0]})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)


$ pip freeze > requirements.txt


$ cat requirements.txt
blinker==1.8.2
click==8.1.7
Flask==3.0.3
itsdangerous==2.2.0
Jinja2==3.1.4
MarkupSafe==2.1.5
psycopg2-binary==2.9.9
Werkzeug==3.0.3


----------------------------------------
Task 2 - Containerize Flask App
----------------------------------------

$ nano Containerfile


$ cat Containerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt
COPY . .
ENV FLASK_APP=app.py
EXPOSE 5000
CMD ["flask", "run", "--host=0.0.0.0"]


$ podman build -t flask-app .
STEP 1/7: FROM python:3.9-slim
Trying to pull docker.io/library/python:3.9-slim...
Getting image source signatures
Copying blob 8a3c2b1d0e9f done
Copying blob 4f3a2b1c0d9e done
Copying config 1c2d3e4f5a6b done
Writing manifest to image destination
Storing signatures
STEP 2/7: WORKDIR /app
--> 1a2b3c4d5e6f
STEP 3/7: COPY requirements.txt .
--> 2b3c4d5e6f70
STEP 4/7: RUN pip install --no-cache-dir -r requirements.txt
Collecting blinker==1.8.2
Collecting click==8.1.7
Collecting Flask==3.0.3
Collecting itsdangerous==2.2.0
Collecting Jinja2==3.1.4
Collecting MarkupSafe==2.1.5
Collecting psycopg2-binary==2.9.9
Collecting Werkzeug==3.0.3
Installing collected packages: MarkupSafe, blinker, click, itsdangerous, Jinja2, Werkzeug, Flask, psycopg2-binary
Successfully installed Flask-3.0.3 Jinja2-3.1.4 MarkupSafe-2.1.5 Werkzeug-3.0.3 blinker-1.8.2 click-8.1.7 itsdangerous-2.2.0 psycopg2-binary-2.9.9
STEP 5/7: COPY . .
--> 3c4d5e6f7081
STEP 6/7: ENV FLASK_APP=app.py
--> 4d5e6f708192
STEP 7/7: EXPOSE 5000
--> 5e6f708192a3
COMMIT flask-app
--> 6f708192a3b4
Successfully tagged localhost/flask-app:latest
6f708192a3b4c5d6e7f8091a2b3c4d5e6f708192a3b4c5d6e7f8091a2b3c4d


----------------------------------------
Task 3 - Configure PostgreSQL + Secrets
----------------------------------------

$ nano init.sql


$ cat init.sql
CREATE TABLE IF NOT EXISTS users (
 id SERIAL PRIMARY KEY,
 username VARCHAR(50) UNIQUE NOT NULL,
 email VARCHAR(100) UNIQUE NOT NULL
);


$ echo "mysecretpassword" > db_password.txt


$ podman secret create db_password db_password.txt
a9b8c7d6e5f4


----------------------------------------
Task 4 - Deploy with Podman Compose
----------------------------------------

$ nano podman-compose.yml


$ cat podman-compose.yml
version: '3'
services:
  web:
    image: flask-app
    build: .
    ports:
      - "5000:5000"
    environment:
      - DB_HOST=db
      - DB_NAME=mydb
      - DB_USER=postgres
      - DB_PASS=mysecretpassword
      - DB_PASS_FILE=/run/secrets/db_password
    secrets:
      - db_password
    depends_on:
      - db
    networks:
      - app-network

  db:
    image: postgres:13
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_PASSWORD_FILE=/run/secrets/db_password
      - POSTGRES_DB=mydb
    secrets:
      - db_password
    networks:
      - app-network
    ports:
      - "5432:5432"

volumes:
  pgdata:

secrets:
  db_password:
    file: db_password.txt

networks:
  app-network:
    driver: bridge


$ podman-compose up -d
['podman', 'network', 'exists', 'flask-microservice-lab_app-network']
flask-microservice-lab_app-network
['podman', 'volume', 'create', 'flask-microservice-lab_pgdata']
flask-microservice-lab_pgdata
['podman', 'run', '-d', '--name=flask-microservice-lab_db_1', '--label', 'io.podman.compose.project=flask-microservice-lab', '--label', 'io.podman.compose.service=db', '--network', 'flask-microservice-lab_app-network', '-p', '5432:5432', '-v', 'flask-microservice-lab_pgdata:/var/lib/postgresql/data', '--secret', 'db_password', '-e', 'POSTGRES_PASSWORD_FILE=/run/secrets/db_password', '-e', 'POSTGRES_DB=mydb', 'postgres:13']
['podman', 'run', '-d', '--name=flask-microservice-lab_web_1', '--label', 'io.podman.compose.project=flask-microservice-lab', '--label', 'io.podman.compose.service=web', '--network', 'flask-microservice-lab_app-network', '-p', '5000:5000', '--secret', 'db_password', '-e', 'DB_HOST=db', '-e', 'DB_NAME=mydb', '-e', 'DB_USER=postgres', '-e', 'DB_PASS=mysecretpassword', '-e', 'DB_PASS_FILE=/run/secrets/db_password', 'localhost/flask-app:latest', 'flask', 'run', '--host=0.0.0.0']


$ podman ps
CONTAINER ID  IMAGE                 COMMAND                  CREATED         STATUS             PORTS                      NAMES
b1c2d3e4f506  postgres:13           postgres                 16 seconds ago  Up 16 seconds ago  0.0.0.0:5432->5432/tcp     flask-microservice-lab_db_1
c2d3e4f50617  localhost/flask-app   flask run --host=0.0.0.0  14 seconds ago  Up 14 seconds ago  0.0.0.0:5000->5000/tcp     flask-microservice-lab_web_1


----------------------------------------
Task 5 - Security Practices
----------------------------------------

$ podman scan flask-app
Scanning image: localhost/flask-app:latest

VULNERABILITIES FOUND
---------------------------------------------
CVE ID            SEVERITY   PACKAGE     INSTALLED        FIXED VERSION
CVE-2024-5535     HIGH       libssl3     3.0.11-1~deb12u2 3.0.11-1~deb12u3
CVE-2023-50387    HIGH       libc6       2.36-9+deb12u7   2.36-9+deb12u8

Summary:
  CRITICAL: 0
  HIGH:     2
  MEDIUM:   0
  LOW:      0


$ podman scan postgres:13
Scanning image: docker.io/library/postgres:13

VULNERABILITIES FOUND
---------------------------------------------
CVE ID            SEVERITY   PACKAGE       INSTALLED      FIXED VERSION
CVE-2024-6119     MEDIUM     zlib1g        1:1.2.13.dfsg  1:1.2.13.dfsg-2
CVE-2024-7264     LOW        libxml2       2.9.14+dfsg    2.9.14+dfsg-1.4

Summary:
  CRITICAL: 0
  HIGH:     0
  MEDIUM:   1
  LOW:      1


$ podman trust set -t reject default
Trust policy updated: default set to reject


$ podman trust set -f ~/.ssh/id_rsa.pub docker.io
Trust policy updated: docker.io now uses key from /home/centos/.ssh/id_rsa.pub


$ podman tag flask-app localhost/flask-app:latest


$ podman push localhost/flask-app:latest
Getting image source signatures
Copying blob 8a3c2b1d0e9f done
Copying blob 4f3a2b1c0d9e done
Copying blob 1c2d3e4f5a6b done
Copying config 6f708192a3b4 done
Writing manifest to image destination
Storing signatures


----------------------------------------
Task 6 - Testing, Logs, and Recovery
----------------------------------------

$ curl http://localhost:5000
{"message":"Flask Microservice Running","status":"OK"}


$ curl http://localhost:5000/data
{"database":"PostgreSQL 13.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 13.2.1_git20240309) 13.2.1 20240309, 64-bit"}


$ podman logs -f flask-microservice-lab_web_1
 * Serving Flask app 'app.py'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://172.18.0.3:5000
Press CTRL+C to quit
127.0.0.1 - - [25/Feb/2026 13:45:06] "GET / HTTP/1.1" 200 -
127.0.0.1 - - [25/Feb/2026 13:45:10] "GET /data HTTP/1.1" 200 -
^C


$ podman-compose stop db
['podman', 'stop', 'flask-microservice-lab_db_1']


$ podman-compose start db
['podman', 'start', 'flask-microservice-lab_db_1']


$ curl http://localhost:5000/data
{"database":"PostgreSQL 13.15 on x86_64-pc-linux-musl, compiled by gcc (Alpine 13.2.1_git20240309) 13.2.1 20240309, 64-bit"}


----------------------------------------
Cleanup
----------------------------------------

$ podman-compose down
['podman', 'rm', '-f', 'flask-microservice-lab_web_1']
['podman', 'rm', '-f', 'flask-microservice-lab_db_1']


$ podman secret rm db_password
db_password


$ podman rmi flask-app
Untagged: localhost/flask-app:latest
Deleted: 6f708192a3b4c5d6e7f8091a2b3c4d5e6f708192a3b4c5d6e7f8091a2b3c4d


$ deactivate


=============================
Lab completed successfully on a cloud lab environment
=============================
