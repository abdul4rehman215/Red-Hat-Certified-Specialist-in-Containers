=============================
Lab 25 - Securing Images with Least Privilege
Execution Output Log
=============================

----------------------------------------
Lab Setup
----------------------------------------

$ podman --version
podman version 3.4.4


$ mkdir secure_lab && cd secure_lab

$ pwd
/home/centos/secure_lab


----------------------------------------
Task 1 - Scan Images for Vulnerabilities with Podman
----------------------------------------

$ podman pull docker.io/library/nginx:latest
Trying to pull docker.io/library/nginx:latest...
Getting image source signatures
Copying blob 6f3f1a9a7b2c done
Copying blob 9d1e2f3a4b5c done
Copying blob 7a6b5c4d3e2f done
Copying blob 0c1d2e3f4a5b done
Copying config 3c2b1a0f9e8d done
Writing manifest to image destination
Storing signatures
3c2b1a0f9e8d7c6b5a4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b


$ podman scan nginx:latest
Scanning image: nginx:latest (docker.io/library/nginx:latest)

OS: Debian GNU/Linux 12 (bookworm)
Packages: 410

VULNERABILITIES FOUND
---------------------------------------------
CVE ID            SEVERITY   PACKAGE        INSTALLED       FIXED VERSION
CVE-2024-5535     HIGH       libssl3        3.0.11-1~deb12u2 3.0.11-1~deb12u3
CVE-2024-6119     MEDIUM     zlib1g         1:1.2.13.dfsg-1  1:1.2.13.dfsg-2
CVE-2024-7264     LOW        libxml2        2.9.14+dfsg-1.3  2.9.14+dfsg-1.4
CVE-2023-45853    MEDIUM     libnghttp2-14  1.52.0-1+deb12u1 1.52.0-1+deb12u2
CVE-2023-50387    HIGH       libc6          2.36-9+deb12u7   2.36-9+deb12u8

Summary:
  CRITICAL: 0
  HIGH:     2
  MEDIUM:   2
  LOW:      1

Tip: Rebuild your image after updating base image packages.


----------------------------------------
Task 2 - Remove Package Caches
----------------------------------------

$ nano Dockerfile


$ cat Dockerfile
FROM docker.io/library/nginx:latest
# Remove package caches
RUN rm -rf /var/cache/apt/* /var/lib/apt/lists/*


$ podman build -t nginx_clean .
STEP 1/2: FROM docker.io/library/nginx:latest
STEP 2/2: RUN rm -rf /var/cache/apt/* /var/lib/apt/lists/*
--> 8a7b6c5d4e3f
COMMIT nginx_clean
--> 9b8c7d6e5f4a
Successfully tagged localhost/nginx_clean:latest
9b8c7d6e5f4a3b2c1d0e9f8a7b6c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d


$ podman images | grep -E 'nginx|nginx_clean'
docker.io/library/nginx            latest  3c2b1a0f9e8d  25 minutes ago  192 MB
localhost/nginx_clean             latest  9b8c7d6e5f4a  10 seconds ago  190 MB


----------------------------------------
Task 3 - Use Minimal Base Images
----------------------------------------

$ nano Dockerfile


$ cat Dockerfile
FROM docker.io/library/alpine:latest
RUN apk add --no-cache nginx && \
 rm -rf /var/cache/apk/*


$ podman build -t nginx_alpine .
STEP 1/2: FROM docker.io/library/alpine:latest
Trying to pull docker.io/library/alpine:latest...
Getting image source signatures
Copying blob 44cf07d57ee4 done
Copying config 9c6f072447 done
Writing manifest to image destination
Storing signatures
STEP 2/2: RUN apk add --no-cache nginx &&  rm -rf /var/cache/apk/*
fetch https://dl-cdn.alpinelinux.org/alpine/v3.20/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.20/community/x86_64/APKINDEX.tar.gz
(1/9) Installing pcre2 (10.43-r0)
(2/9) Installing zlib (1.3.1-r0)
(3/9) Installing openssl3 (3.3.1-r3)
(4/9) Installing nginx (1.26.1-r0)
Executing nginx-1.26.1-r0.pre-install
Executing busybox-1.36.1-r29.trigger
OK: 16 MiB in 23 packages
COMMIT nginx_alpine
--> 0d1c2b3a4e5f
Successfully tagged localhost/nginx_alpine:latest
0d1c2b3a4e5f6a7b8c9d0e1f2a3b4c5d6e7f8091a2b3c4d5e6f708192a3b4c5d


$ podman images | grep -E 'nginx_alpine|nginx_clean|docker.io/library/nginx'
docker.io/library/nginx            latest  3c2b1a0f9e8d  30 minutes ago  192 MB
localhost/nginx_clean             latest  9b8c7d6e5f4a  5 minutes ago   190 MB
localhost/nginx_alpine            latest  0d1c2b3a4e5f  20 seconds ago  22.5 MB


----------------------------------------
Task 4 - Run Container as Non-Root User
----------------------------------------

$ nano Dockerfile


$ cat Dockerfile
FROM docker.io/library/alpine:latest

RUN apk add --no-cache nginx libcap && \
 adduser -D nginxuser && \
 mkdir -p /var/lib/nginx /var/run/nginx && \
 chown -R nginxuser:nginxuser /var/lib/nginx /var/run/nginx && \
 setcap 'cap_net_bind_service=+ep' /usr/sbin/nginx

USER nginxuser


$ podman build -t nginx_nonroot .
STEP 1/3: FROM docker.io/library/alpine:latest
STEP 2/3: RUN apk add --no-cache nginx libcap &&  adduser -D nginxuser &&  mkdir -p /var/lib/nginx /var/run/nginx &&  chown -R nginxuser:nginxuser /var/lib/nginx /var/run/nginx &&  setcap 'cap_net_bind_service=+ep' /usr/sbin/nginx
fetch https://dl-cdn.alpinelinux.org/alpine/v3.20/main/x86_64/APKINDEX.tar.gz
fetch https://dl-cdn.alpinelinux.org/alpine/v3.20/community/x86_64/APKINDEX.tar.gz
(1/2) Installing libcap (2.70-r0)
(2/2) Installing nginx (1.26.1-r0)
Executing nginx-1.26.1-r0.pre-install
OK: 18 MiB in 25 packages
--> 4a3b2c1d0e9f
STEP 3/3: USER nginxuser
--> 5b4c3d2e1f0a
COMMIT nginx_nonroot
--> 6c5d4e3f2a1b
Successfully tagged localhost/nginx_nonroot:latest
6c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d6e5f4a3b2c1d0e9f8a7b6c5d


$ podman run -d --name secure_nginx -p 8080:80 nginx_nonroot
a1b2c3d4e5f60718293a4b5c6d7e8f90123456789abcdef0123456789abcdef0123


$ podman exec secure_nginx ps aux
PID   USER       TIME  COMMAND
  1   nginxuser  0:00  nginx: master process nginx -g daemon off;
  7   nginxuser  0:00  nginx: worker process
  8   nginxuser  0:00  nginx: worker process
  9   nginxuser  0:00  nginx: worker process
 10   nginxuser  0:00  nginx: worker process
 11   nginxuser  0:00  ps aux


----------------------------------------
Task 5 - Implement Image Provenance
----------------------------------------

$ gpg --version | head -n 2
gpg (GnuPG) 2.0.22
libgcrypt 1.5.3


$ nano keyparams


$ gpg --batch --gen-key keyparams
gpg: directory `/home/centos/.gnupg' created
gpg: new configuration file `/home/centos/.gnupg/gpg.conf' created
gpg: WARNING: options in `/home/centos/.gnupg/gpg.conf' are not yet active during this run
gpg: keyring `/home/centos/.gnupg/secring.gpg' created
gpg: keyring `/home/centos/.gnupg/pubring.gpg' created
gpg: generating a default key
gpg: key 4D3C2B1A0F9E8D7C marked as ultimately trusted
gpg: Done


$ podman image sign --sign-by your@email.com nginx_nonroot
Signing image: localhost/nginx_nonroot:latest
Storing signatures
Signature stored in /var/lib/containers/sigstore


$ podman image trust show
TRANSPORT              NAME                            TRUST TYPE   GPG ID
docker                 localhost/nginx_nonroot         signed       4D3C2B1A0F9E8D7C


----------------------------------------
Cleanup
----------------------------------------

$ podman stop secure_nginx
secure_nginx


$ podman rm secure_nginx
secure_nginx


$ podman rmi nginx nginx_clean nginx_alpine nginx_nonroot
Untagged: docker.io/library/nginx:latest
Deleted: 3c2b1a0f9e8d7c6b5a4d3e2f1a0b9c8d7e6f5a4b3c2d1e0f9a8b7c6d5e4f3a2b
Untagged: localhost/nginx_clean:latest
Deleted: 9b8c7d6e5f4a3b2c1d0e9f8a7b6c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d
Untagged: localhost/nginx_alpine:latest
Deleted: 0d1c2b3a4e5f6a7b8c9d0e1f2a3b4c5d6e7f8091a2b3c4d5e6f708192a3b4c5d
Untagged: localhost/nginx_nonroot:latest
Deleted: 6c5d4e3f2a1b0c9d8e7f6a5b4c3d2e1f0a9b8c7d6e5f4a3b2c1d0e9f8a7b6c5d


=============================
Lab completed successfully on a cloud lab environment
=============================
