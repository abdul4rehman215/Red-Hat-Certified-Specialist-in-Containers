=============================
Lab 36 - Managing Environment Files and Secrets with Podman
Execution Output Log
=============================

----------------------------------------
Lab Setup
----------------------------------------

$ mkdir podman-secrets-lab && cd podman-secrets-lab


$ pwd
/home/centos/podman-secrets-lab


----------------------------------------
Task 1 - Working with Environment Files
----------------------------------------

$ nano .env


$ cat .env
APP_NAME=MySecureApp
DB_USER=admin
DB_PASS=SuperSecret123!


$ podman run --rm --env-file=.env alpine env | grep -E 'APP_NAME|DB_'
APP_NAME=MySecureApp
DB_USER=admin
DB_PASS=SuperSecret123!


----------------------------------------
Task 2 - Working with Podman Secrets
----------------------------------------

$ echo "TopSecretPassword" > db_password.txt


$ podman secret create db_password_secret db_password.txt
f1e2d3c4b5a6


$ podman secret ls
ID            NAME                DRIVER  CREATED        UPDATED
f1e2d3c4b5a6  db_password_secret  file    8 seconds ago  8 seconds ago


$ podman run --rm --secret=db_password_secret alpine cat /run/secrets/db_password_secret
TopSecretPassword


----------------------------------------
Task 3 - Podman Compose Integration
----------------------------------------

$ nano docker-compose.yml


$ cat docker-compose.yml
version: '3.8'
services:
  webapp:
    image: alpine
    env_file: .env
    secrets:
      - db_password_secret
    command: sh -c "echo \$APP_NAME && cat /run/secrets/db_password_secret"

secrets:
  db_password_secret:
    external: true


$ podman-compose --version
-bash: podman-compose: command not found


$ pip3 --version
pip 9.0.3 from /usr/lib/python2.7/site-packages (python 2.7)


$ python3 --version
Python 3.6.8


$ sudo yum install -y python3-pip
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirror.centos.org
 * extras: mirror.centos.org
 * updates: mirror.centos.org
Resolving Dependencies
--> Running transaction check
---> Package python3-pip.noarch 0:9.0.3-8.el7 will be installed
--> Finished Dependency Resolution

Dependencies Resolved

================================================================================
 Package          Arch        Version            Repository               Size
================================================================================
Installing:
 python3-pip      noarch      9.0.3-8.el7        extras                  1.6 M

Transaction Summary
================================================================================
Install  1 Package

Total download size: 1.6 M
Installed size: 7.1 M
Downloading packages:
python3-pip-9.0.3-8.el7.noarch.rpm                              | 1.6 MB  00:01
Running transaction check
Running transaction test
Transaction test succeeded
Running transaction
  Installing : python3-pip-9.0.3-8.el7.noarch                                   1/1
  Verifying  : python3-pip-9.0.3-8.el7.noarch                                   1/1

Installed:
  python3-pip.noarch 0:9.0.3-8.el7

Complete!


$ pip3 --version
pip 9.0.3 from /usr/lib/python3.6/site-packages (python 3.6)


$ pip3 install --user podman-compose
Collecting podman-compose
  Downloading podman_compose-1.0.6-py2.py3-none-any.whl
Collecting pyyaml
  Downloading PyYAML-6.0.1-cp36-cp36m-manylinux_2_17_x86_64.manylinux2014_x86_64.whl
Collecting python-dotenv
  Downloading python_dotenv-1.0.1-py3-none-any.whl
Installing collected packages: pyyaml, python-dotenv, podman-compose
Successfully installed podman-compose-1.0.6 python-dotenv-1.0.1 pyyaml-6.0.1
WARNING: The script podman-compose is installed in '/home/centos/.local/bin' which is not on PATH.


$ export PATH=$PATH:/home/centos/.local/bin


$ podman-compose --version
podman-compose version: 1.0.6


$ podman-compose up
['podman', 'network', 'exists', 'podman-secrets-lab_default']
podman-secrets-lab_default
['podman', 'run', '--name=podman-secrets-lab_webapp_1', '--label', 'io.podman.compose.project=podman-secrets-lab', '--label', 'io.podman.compose.service=webapp', '--env-file', '.env', '--secret', 'db_password_secret', 'alpine', 'sh', '-c', 'echo $APP_NAME && cat /run/secrets/db_password_secret']
podman-secrets-lab_webapp_1  | MySecureApp
podman-secrets-lab_webapp_1  | TopSecretPassword
podman-secrets-lab_webapp_1 exited with code 0


----------------------------------------
Cleanup
----------------------------------------

$ podman secret rm db_password_secret
db_password_secret


$ cd .. && rm -rf podman-secrets-lab


=============================
Lab completed successfully on a cloud lab environment
=============================
